<!DOCTYPE html>
<html>
<head>
    <title>VR Cyber Command - Fixed & Polished</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style> @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap'); </style>
</head>
<body>
    <canvas id="matrix-canvas" width="512" height="256" style="display: none;"></canvas>
    <script>
        (function(){
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            let w = canvas.width; let h = canvas.height;
            let cols = Math.floor(w / 20) + 1; let ypos = Array(cols).fill(0);
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
            function drawMatrix() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = '#0f0'; ctx.font = '20px monospace';
                ypos.forEach((y, ind) => {
                    const text = String.fromCharCode(Math.random() * 128);
                    const x = ind * 20; ctx.fillText(text, x, y);
                    if (y > h && Math.random() > 0.975) ypos[ind] = 0; else ypos[ind] = y + 20;
                });
                requestAnimationFrame(drawMatrix);
            }
            drawMatrix();
        })();
    </script>

    <script>
        // --- GAME LOGIC ---
        const gameData = [
            { 
                level: 1, 
                name: "MITM ATTACK", 
                alert: "ALERT: ARP SPOOFING DETECTED", 
                logs: "[SYS]: Gateway MAC address mismatch.\n[NET]: 192.168.1.5 is broadcasting fake packets.\n[WARN]: Man-in-the-Middle active.", 
                options: [
                    { label: "Flush DNS", correct: false }, 
                    { label: "Static ARP Entry", correct: true }, 
                    { label: "Ping Ext IP", correct: false }
                ] 
            },
            { 
                level: 2, 
                name: "DDOS FLOOD", 
                alert: "CRITICAL: UDP FLOOD INBOUND", 
                logs: "[FIREWALL]: Traffic spike > 50Gbps.\n[CPU]: Server load critical (99%).\n[SRC]: Botnet signature identified.", 
                options: [
                    { label: "Filter UDP", correct: true }, 
                    { label: "Restart Network", correct: false }, 
                    { label: "Reboot Server", correct: false }
                ] 
            },
            { 
                level: 3, 
                name: "RANSOMWARE", 
                alert: "BREACH: ENCRYPTION STARTED", 
                logs: "[IDS]: 'WannaCry' signature detected.\n[DISK]: Unauthorized write operations.\n[PROC]: Kill signal sent to PID 8821.", 
                options: [
                    { label: "Terminate PID 8821", correct: true }, 
                    { label: "Backup Files", correct: false }, 
                    { label: "Wipe Drives", correct: false }
                ] 
            }
        ];
        
        let currentLevel = 0; 
        let timeLeft = 240; 
        let timerInterval;
        
        AFRAME.registerComponent('soc-manager', {
            init: function () { 
                this.loadLevel(0); 
                this.startTimer(); 
            },
            
            startTimer: function() { 
                const timerEl = document.querySelector('#timer-display'); 
                timerInterval = setInterval(() => { 
                    if(timeLeft > 0) { 
                        timeLeft--; 
                        let m = Math.floor(timeLeft / 60); 
                        let s = timeLeft % 60; 
                        timerEl.setAttribute('value', `TIME REMAINING: 0${m}:${s < 10 ? '0'+s : s}`); 
                        if(timeLeft < 60) timerEl.setAttribute('color', 'red'); 
                    } else { 
                        this.triggerGlitch("TIMEOUT"); 
                    } 
                }, 1000); 
            },
            
            loadLevel: function(idx) { 
                if (idx >= gameData.length) { 
                    this.missionSuccess(); 
                    return; 
                } 
                
                const data = gameData[idx]; 
                
                // Update Panels
                document.querySelector('#alert-title').setAttribute('value', data.alert); 
                document.querySelector('#log-display').setAttribute('value', data.logs); 
                
                // Alert Light Animation
                const roomLight = document.querySelector('#alert-light'); 
                roomLight.setAttribute('intensity', '1.2'); 
                roomLight.setAttribute('animation', 'property: intensity; from: 0.8; to: 1.5; dur: 800; dir: alternate; loop: true'); 

                // Update Buttons
                const labels = document.querySelectorAll('.cmd-label'); 
                data.options.forEach((opt, i) => { 
                    labels[i].setAttribute('value', `> ${opt.label}`); 
                }); 
            },
            
            // --- FIXED VERIFICATION LOGIC ---
            // Now accepts the INDEX of the button clicked, instead of reading HTML attributes
            verifyCommand: function(btnIndex) { 
                if (currentLevel >= gameData.length) return; // Prevent errors if game is won

                // Direct Data Check (Bulletproof)
                const isCorrect = gameData[currentLevel].options[btnIndex].correct; 
                const output = document.querySelector('#terminal-output'); 
                
                output.setAttribute('value', "EXECUTING COMMAND..."); 
                
                if (isCorrect) { 
                    output.setAttribute('color', '#00ff00'); 
                    output.setAttribute('value', "ACCESS GRANTED. PATCHING..."); 
                    
                    // Delay to show success message before next level
                    setTimeout(() => { 
                        currentLevel++; 
                        this.loadLevel(currentLevel); 
                        if (currentLevel < gameData.length) {
                            output.setAttribute('value', "AWAITING INPUT..."); 
                        }
                    }, 2000); 
                } else { 
                    this.triggerGlitch(); 
                } 
            },
            
            triggerGlitch: function() { 
                const cam = document.querySelector('#rig'); 
                const terminal = document.querySelector('#terminal-output'); 
                
                // 1. Camera Shake
                cam.setAttribute('animation', 'property: position; from: 0 0 2.5; to: 0.1 0.1 2.5; dur: 50; loop: 10; dir: alternate'); 
                
                // 2. Big Red Error Message
                terminal.setAttribute('value', "CRITICAL ERROR: FILES CORRUPTED"); 
                terminal.setAttribute('color', 'red'); 
                
                // 3. Lockout for 3 seconds
                setTimeout(() => { 
                    cam.removeAttribute('animation'); 
                    cam.setAttribute('position', '0 0 2.5'); 
                    terminal.setAttribute('value', "SYSTEM REBOOTING..."); 
                    
                    setTimeout(() => {
                        terminal.setAttribute('value', "AWAITING INPUT...");
                        terminal.setAttribute('color', '#00ff00');
                    }, 1500);
                }, 3000); 
            },
            
            missionSuccess: function() { 
                clearInterval(timerInterval); // Stop timer
                
                // Update UI to Green
                document.querySelector('#alert-title').setAttribute('value', "SYSTEM SECURE"); 
                document.querySelector('#alert-panel').setAttribute('material', 'color: #004400; opacity: 0.4'); 
                document.querySelector('#timer-display').setAttribute('value', "00:00");
                document.querySelector('#timer-display').setAttribute('color', '#00ff00');

                // Room Light turns to Victory Blue
                const roomLight = document.querySelector('#alert-light'); 
                roomLight.setAttribute('color', '#00aaff'); 
                roomLight.removeAttribute('animation'); 
                roomLight.setAttribute('intensity', '0.6'); 
                
                document.querySelector('#log-display').setAttribute('value', "ALL THREATS NEUTRALIZED.\nREPORT GENERATED."); 
                
                // Final Success Message
                const term = document.querySelector('#terminal-output');
                term.setAttribute('value', "MISSION SUCCESSFUL"); 
                term.setAttribute('color', '#00ff00');
            }
        });
        
        // Helper function that passes the index directly
        function clickBtn(index) { 
            document.querySelector('a-scene').components['soc-manager'].verifyCommand(index); 
        }
    </script>

    <a-scene soc-manager background="color:
